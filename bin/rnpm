#!/usr/bin/env node

var app = require('commander')
  , fs = require('fs')
  , rnpm = require('../lib')
  , path = require('path');

app
  .version(JSON.parse(fs.readFileSync(path.join(__dirname, '..', 'package.json'), 'utf-8')).version);

app
  .option('--prod, --production', 'Ignore `devDependencies`.')
  .option('--strict', 'Fail on inconsistent dependencies.')

app
  .command('install')
  .alias('i')
  .description('Recursively install dependencies')
  .action(function() {
    rnpm.install({ production: app.production, strict: app.strict })
  });

app
  .command('prune')
  .description('Recursive npm prune')
  .action(function() {
    rnpm.prune({ production: app.production })
  });

app
  .command('shrinkwrap')
  .description('Recursive npm shrinkwrap')
  .action(function() {
    rnpm.custom('shrinkwrap')
  });

app
  .command('list')
  .alias('ls')
  .option('--depth [n]', 'Max display depth of the dependency tree', parseInt)
  .description('Recursive npm list')
  .action(function(opts) {
    rnpm.custom('list', {depth: opts.depth || 0})
  });

app
  .command('analyze')
  .description('Analyze dependencies and find inconsistencies')
  .action(function() {
    rnpm.analyze({ production: app.production })
  });

app
  .command('update-dep <dependency> <version>')
  .description('Update a dependency version recursively')
  .action(function(dep, version) {
    rnpm.updateDep({ dependency: dep, version: version });
  });

app
  .command('normalize')
  .description('Normalize dependencies recursively')
  .action(function() {
    rnpm.normalize({}, function() {
      process.exit(0);
    })
  });

app
  .command('execute <command...>')
  .alias('exec')
  .description('Execute an arbitrary command in every component')
  .action(function(args) {
    var cmd = args.shift()
    rnpm.execute(cmd, {}, args)
  });

app.on('--help', function(){
  console.log('  Examples:\n');
  console.log('    $ rnpm i --prod')
  console.log('    $ rnpm update-dep each-async 1.0.4')
  console.log('    $ rnpm exec -- ls -A')
  console.log('    $ rnpm ls --depth=1')
})

app
  .parse(process.argv);

if (process.argv.length == 2) {
  app.help()
}
